app-id: org.gajim.Gajim.Devel
runtime: org.gnome.Platform
runtime-version: '44'
sdk: org.gnome.Sdk
command: gajim-devel
tags:
  - devel
  - development
  - nightly
rename-icon: org.gajim.Gajim
rename-desktop-file: org.gajim.Gajim.desktop
rename-appdata-file: org.gajim.Gajim.appdata.xml
finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --system-talk-name=org.freedesktop.login1
  - --talk-name=org.mpris.MediaPlayer2.*
  # Automatic status
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.gnome.Mutter.IdleMonitor
  # Keyring
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd5
  # Notifications
  - --talk-name=org.freedesktop.Notifications
  # tray/status icon
  - --talk-name=org.kde.StatusNotifierWatcher
  # GnuPG
  - --filesystem=~/.gnupg
  - --filesystem=xdg-run/gnupg
  # camera access
  - --device=all
  # extensions
  - --env=PYTHONPATH=/app/plugins/site-packages
  - --env=GI_TYPELIB_PATH=/app/lib/girepository-1.0:/app/plugins/lib/girepository-1.0

add-extensions:
  org.gajim.Gajim.Devel.Plugin:
    directory: plugins
    merge-dirs: lib;site-packages
    add-ld-path: lib
    subdirectories: true
    no-autodownload: true
    autodelete: true

build-options:
  env:
    PIP_PREFIX: /app
    PIP_DISABLE_PIP_VERSION_CHECK: "1"

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - '*.a'
  - '*.la'

modules:
  - shared-modules/libappindicator/libappindicator-gtk3-introspection-12.10.json

  - name: python3-pyparsing
    buildsystem: simple
    build-commands:
      - pip3 install pyparsing-3.1.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/p/pyparsing/pyparsing-3.1.0-py3-none-any.whl
        sha256: d554a96d1a7d3ddaf7183104485bc19fd80543ad6ac5bdb6426719d766fb06c1

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - pip3 install packaging-23.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/p/packaging/packaging-23.1-py3-none-any.whl
        sha256: 994793af429502c4ea2ebf6bf664629d07c1a9fe974af92966e4b8d2df7edc61

  - name: python3-pycparser
    buildsystem: simple
    build-commands:
      - pip3 install pycparser-2.21-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/p/pycparser/pycparser-2.21-py2.py3-none-any.whl
        sha256: 8ee45429555515e1f6b185e78100aea234072576aa43ab53aefcae078162fca9

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/c/cffi/cffi-1.15.1.tar.gz
        sha256: d400bfb9a37b1351253cb402671cea7e89bdecc294e8016a707f6d1d8ac934f9

  - name: python3-asn1crypto
    buildsystem: simple
    build-commands:
      - pip3 install asn1crypto-1.5.1-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/a/asn1crypto/asn1crypto-1.5.1-py2.py3-none-any.whl
        sha256: db4e40728b728508912cbb3d44f19ce188f218e9eba635821bb4b68564f8fd67

  - name: python3-idna
    buildsystem: simple
    build-commands:
      - pip3 install idna-3.4-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/i/idna/idna-3.4-py3-none-any.whl
        sha256: 90b77e79eaa3eba6de819a0c442c0b4ceefc341a7a2ab77d7562bf49f425c5c2

  - name: python3-cryptography
    buildsystem: simple
    only-arches:
      - aarch64
    build-commands:
      - pip3 install cryptography-41.0.2-cp37-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cp37/c/cryptography/cryptography-41.0.2-cp37-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
        sha256: 439c3cc4c0d42fa999b83ded80a9a1fb54d53c58d6e59234cfe97f241e6c781d

  - name: python3-cryptography
    buildsystem: simple
    only-arches:
      - x86_64
    build-commands:
      - pip3 install cryptography-41.0.2-cp37-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cp37/c/cryptography/cryptography-41.0.2-cp37-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: f14ad275364c8b4e525d018f6716537ae7b6d369c094805cae45300847e0894f

  - name: python3-dbus-python
    build-options:
      env:
        PYTHON_VERSION: '3'
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/d/dbus-python/dbus-python-1.3.2.tar.gz
        sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8

  - name: python3-jeepney
    buildsystem: simple
    build-commands:
      - pip3 install jeepney-0.8.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/j/jeepney/jeepney-0.8.0-py3-none-any.whl
        sha256: c0a454ad016ca575060802ee4d590dd912e35c122fa04e70306de3d076cce755

  - name: python3-secretstorage
    buildsystem: simple
    build-commands:
      - pip3 install SecretStorage-3.3.3-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/S/SecretStorage/SecretStorage-3.3.3-py3-none-any.whl
        sha256: f356e6628222568e3af06f2eba8df495efa13b3b63081dafd4f7d9a7b7bc9f99

  # importlib-metadata dependency
  - name: python3-zipp
    buildsystem: simple
    build-commands:
      - pip3 install zipp-3.16.2-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/z/zipp/zipp-3.16.2-py3-none-any.whl
        sha256: 679e51dd4403591b2d6838a48de3d283f3d188412a9782faadf845f298736ba0

  # jaraco.classes dependency
  - name: python3-more-itertools
    buildsystem: simple
    build-commands:
      - pip3 install more_itertools-10.0.0-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/m/more_itertools/more_itertools-10.0.0-py3-none-any.whl
        sha256: 928d514ffd22b5b0a8fce326d57f423a55d2ff783b093bab217eda71e732330f

  # keyring dependency
  - name: python3-importlib-metadata
    buildsystem: simple
    build-commands:
      - pip3 install importlib_metadata-6.8.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/i/importlib_metadata/importlib_metadata-6.8.0-py3-none-any.whl
        sha256: 3ebb78df84a805d7698245025b975d9d67053cd94c79245ba4b3eb694abe68bb

  - name: python3-jaraco.classes
    buildsystem: simple
    build-commands:
      - pip3 install jaraco.classes-3.3.0-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/j/jaraco.classes/jaraco.classes-3.3.0-py3-none-any.whl
        sha256: 10afa92b6743f25c0cf5f37c6bb6e18e2c5bb84a16527ccfc0040ea377e7aaeb

  - name: python3-keyring
    buildsystem: simple
    build-commands:
      - pip3 install keyring-24.2.0-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/k/keyring/keyring-24.2.0-py3-none-any.whl
        sha256: 4901caaf597bfd3bbd78c9a0c7c4c29fcd8310dab2cffefe749e916b6527acd6

  - name: python3-css-parser
    buildsystem: simple
    build-commands:
      - pip3 install css_parser-1.0.9-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/c/css_parser/css_parser-1.0.9-py2.py3-none-any.whl
        sha256: e18f66961103b61df25aa6df0dc808ab61c23e65ae6c1a8c149fe71911190495

  - name: python3-precis_i18n
    buildsystem: simple
    build-commands:
      - pip3 install precis_i18n-1.0.5-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/p/precis_i18n/precis_i18n-1.0.5-py3-none-any.whl
        sha256: 14eceeae73dc7bbd1c4a17d2ac7143db87d65ded98eec44c47911270812862a3

  # GSound dependency
  - shared-modules/libcanberra/libcanberra.json

  - name: gsound
    buildsystem: meson
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gsound/1.0/gsound-1.0.3.tar.xz
        sha256: ca2d039e1ebd148647017a7f548862350bc9af01986d39f10cfdc8e95f07881a

  - name: gspell
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gspell/1.12/gspell-1.12.2.tar.xz
        sha256: b4e993bd827e4ceb6a770b1b5e8950fce3be9c8b2b0cbeb22fdf992808dd2139

  - name: farstream
    rm-configure: true
    sources:
      - type: archive
        url: https://freedesktop.org/software/farstream/releases/farstream/farstream-0.2.9.tar.gz
        sha256: cb7d112433cf7c2e37a8ec918fb24f0ea5cb293cfa1002488e431de26482f47b
      - type: patch
        path: farstream-make-4.3.patch

  - name: python3-pillow
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/p/pillow/Pillow-10.0.0.tar.gz
        sha256: 9c82b5b3e043c7af0d95792d0d20ccf68f61a1fec6b3530e718b688422727396

  # sentry-sdk dependency
  - name: python3-urllib3
    buildsystem: simple
    build-commands:
      - pip3 install urllib3-1.26.16-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/u/urllib3/urllib3-1.26.16-py2.py3-none-any.whl
        sha256: 8d36afa7616d8ab714608411b4a3b13e58f463aee519024578e062e141dce20f

  - name: python3-certifi
    buildsystem: simple
    build-commands:
      - pip3 install certifi-2023.7.22-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/c/certifi/certifi-2023.7.22-py3-none-any.whl
        sha256: 92d6037539857d8206b8f6ae472e8b77db8058fec5937a1ef3f54304089edbb9

  - name: python3-sentry-sdk
    buildsystem: simple
    build-commands:
      - pip3 install sentry_sdk-1.28.1-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/s/sentry_sdk/sentry_sdk-1.28.1-py2.py3-none-any.whl
        sha256: 6bdb25bd9092478d3a817cb0d01fa99e296aea34d404eac3ca0037faa5c2aa0a

  # gssapi dependency
  - name: python3-decorator
    buildsystem: simple
    build-commands:
      - pip3 install decorator-5.1.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/d/decorator/decorator-5.1.1-py3-none-any.whl
        sha256: b8c3f85900b9dc423225913c5aace94729fe1fa9763b38939a95226f02d37186

  # qrcode dependencies
  - name: python3-pypng
    buildsystem: simple
    build-commands:
      - pip3 install pypng-0.20220715.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/p/pypng/pypng-0.20220715.0-py3-none-any.whl
        sha256: 4a43e969b8f5aaafb2a415536c1a8ec7e341cd6a3f957fd5b5f32a4cfeed902c

  - name: python3-typing-extensions
    buildsystem: simple
    build-commands:
      - pip3 install typing_extensions-4.7.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/t/typing_extensions/typing_extensions-4.7.1-py3-none-any.whl
        sha256: 440d5dd3af93b060174bf433bccd69b0babc3b15b1a8dca43789fd7f61514b36

  # OMEMO dependencies
  - name: python3-qrcode
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/q/qrcode/qrcode-7.4.2.tar.gz
        sha256: 9dd969454827e127dbd93696b20747239e6d540e082937c90f14ac95b30f5845

  - name: python3-protobuf
    buildsystem: simple
    build-commands:
      - pip3 install --no-deps protobuf-4.23.4-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/p/protobuf/protobuf-4.23.4-py3-none-any.whl
        sha256: e9d0be5bf34b275b9f87ba7407796556abeeba635455d036c7351f7c183ef8ff

  - name: python3-omemo-dr
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation .
    sources:
      - type: git
        url: https://dev.gajim.org/gajim/omemo-dr.git

  # nbxmpp dependency (optional)
  - name: python3-gssapi
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/g/gssapi/gssapi-1.8.2.tar.gz
        sha256: b78e0a021cc91158660e4c5cc9263e07c719346c35a9c0f66725e914b235c89a

  - name: python3-nbxmpp
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation .
    sources:
      - type: git
        url: https://dev.gajim.org/gajim/python-nbxmpp.git

  - name: gajim
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation .
      - ./pep517build/build_metadata.py
      - ./pep517build/install_metadata.py dist/metadata --prefix=/app
      - touch /app/share/run-as-flatpak
      - cp -t ${FLATPAK_DEST} app-overrides.json
      - echo -e '#!/bin/sh\ngajim --gapplication-app-id=org.gajim.Gajim.Devel "$@"'
        > /app/bin/gajim-devel
      - chmod 755 /app/bin/gajim-devel
    sources:
      - type: git
        url: https://dev.gajim.org/gajim/gajim.git
      - type: file
        path: app-overrides.json
      - type: shell
        commands:
          - sed -i "s+<id>org.gajim.Gajim</id>+<id>org.gajim.Gajim.Devel</id>+" data/org.gajim.Gajim.appdata.xml.in
          - sed -i "s+<name>Gajim</name>+<name>Gajim (Nightly)</name>+" data/org.gajim.Gajim.appdata.xml.in
          - sed -i "s+Exec=gajim+Exec=gajim-devel+" data/org.gajim.Gajim.desktop.in
          - mv gajim/data/icons/hicolor/scalable/apps/org.gajim.Gajim{.Devel,}.svg
    post-install:
      - install -d /app/plugins
