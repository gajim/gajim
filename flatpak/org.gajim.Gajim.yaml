app-id: org.gajim.Gajim.Devel
runtime: org.gnome.Platform
runtime-version: '40'
sdk: org.gnome.Sdk
command: gajim-devel
tags:
  - devel
  - development
  - nightly
rename-icon: org.gajim.Gajim
rename-desktop-file: org.gajim.Gajim.desktop
rename-appdata-file: org.gajim.Gajim.appdata.xml
finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --system-talk-name=org.freedesktop.GeoClue2
  - --system-talk-name=org.freedesktop.login1
  - --talk-name=org.mpris.MediaPlayer2.*
  - --talk-name=org.freedesktop.portal.Fcitx
  # Automatic status
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.gnome.Mutter.IdleMonitor
  # Keyring
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd5
  # GnuPG
  - --filesystem=~/.gnupg
  # camera access
  - --device=all
  # extensions
  - --env=PYTHONPATH=/app/plugins/site-packages
  - --env=GI_TYPELIB_PATH=/app/lib/girepository-1.0:/app/plugins/lib/girepository-1.0

add-extensions:
  org.gajim.Gajim.Devel.Plugin:
    directory: plugins
    merge-dirs: lib;site-packages
    add-ld-path: lib
    subdirectories: true
    no-autodownload: true
    autodelete: true

cleanup:
  - /include
  - /lib/debug
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - '*.a'
  - '*.la'

modules:
  - name: python3-pyparsing
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app pyparsing-2.4.7-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/8a/bb/488841f56197b13700afd5658fc279a2025a39e22449b7cf29864669b15d/pyparsing-2.4.7-py2.py3-none-any.whl
        sha256: ef9d7589ef3c200abe66653d3f1ab1033c3c419ae9b9bdb1240a85b024efc88b

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app packaging-20.9-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/3e/89/7ea760b4daa42653ece2380531c90f64788d979110a2ab51049d92f408af/packaging-20.9-py2.py3-none-any.whl
        sha256: 67714da7f7bc052e064859c05c595155bd1ee9f69f76557e21f051443c20947a

  - name: python3-pycparser
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app pycparser-2.20-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/ae/e7/d9c3a176ca4b02024debf82342dab36efadfc5776f9c8db077e8f6e71821/pycparser-2.20-py2.py3-none-any.whl
        sha256: 7582ad22678f0fcd81102833f60ef8d0e57288b6b5fb00323d101be910e35705

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/a8/20/025f59f929bbcaa579704f443a438135918484fffaacfaddba776b374563/cffi-1.14.5.tar.gz
        sha256: fd78e5fee591709f32ef6edb9a015b4aa1a5022598e36227500c8f4e02328d9c

  - name: python3-asn1crypto
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app asn1crypto-1.4.0-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/b5/a8/56be92dcd4a5bf1998705a9b4028249fe7c9a035b955fe93b6a3e5b829f8/asn1crypto-1.4.0-py2.py3-none-any.whl
        sha256: 4bcdf33c861c7d40bdcd74d8e4dd7661aac320fcdf40b9a3f95b4ee12fde2fa8

  - name: python3-idna
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app idna-3.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/29/88/c52aae187d3b128a0f13f36a6c987fc0d408d03a678ad9996516925d8495/idna-3.1-py3-none-any.whl
        sha256: 5205d03e7bcbb919cc9c19885f9920d622ca52448306f2377daede5cf3faac16

  - name: python3-cryptography
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/d4/85/38715448253404186029c575d559879912eb8a1c5d16ad9f25d35f7c4f4c/cryptography-3.3.2.tar.gz
        sha256: 5a60d3780149e13b7a6ff7ad6526b38846354d11a15e21068e57073e29e19bed

  - name: python3-pyopenssl
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app pyOpenSSL-20.0.1-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/b2/5e/06351ede29fd4899782ad335c2e02f1f862a887c20a3541f17c3fa1a3525/pyOpenSSL-20.0.1-py2.py3-none-any.whl
        sha256: 818ae18e06922c066f777a33f1fca45786d85edfe71cd043de6379337a7f274b

  - name: python3-dbus-python
    build-options:
      env:
        PYTHON_VERSION: '3'
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/62/7e/d4fb56a1695fa65da0c8d3071855fa5408447b913c58c01933c2f81a269a/dbus-python-1.2.16.tar.gz
        sha256: 11238f1d86c995d8aed2e22f04a1e3779f0d70e587caffeab4857f3c662ed5a4

  - name: python3-jeepney
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app jeepney-0.6.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/51/b0/a6ea72741aaac3f37fb96d195e4ee576a103c4c04e279bc6b446a70960e1/jeepney-0.6.0-py3-none-any.whl
        sha256: aec56c0eb1691a841795111e184e13cad504f7703b9a64f63020816afa79a8ae

  - name: python3-secretstorage
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app SecretStorage-3.3.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d9/1e/29cd69fdac7391aa51510dfd42aa70b4e6a826c8cd019ee2a8ab9ec0777f/SecretStorage-3.3.1-py3-none-any.whl
        sha256: 422d82c36172d88d6a0ed5afdec956514b189ddbfb72fefab0c8a1cee4eaf71f

  - name: python3-zipp
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app zipp-3.4.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0f/8c/715c54e9e34c0c4820f616a913a7de3337d0cd79074dd1bed4dd840f16ae/zipp-3.4.1-py3-none-any.whl
        sha256: 51cb66cc54621609dd593d1787f286ee42a5c0adbb4b29abea5a63edc3e03098

  # keyring dependency
  - name: python3-importlib-metadata
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app importlib_metadata-3.9.0-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d9/10/191b97506cd4cceb4b860fb5c75b26feeefbca5a8f7f4687bca71e215cc6/importlib_metadata-3.9.0-py3-none-any.whl
        sha256: 6fd684b4c6c7bb36d57e93d57fc244b5ffc08faa1c298bcda3dfbbbf19d7550a

  - name: python3-keyring
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app keyring-23.0.1-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/26/f9/41230ac47f738f1ba66676dc8d3b30ca5b1f9eb0230fc204bcd9836c4ae9/keyring-23.0.1-py3-none-any.whl
        sha256: 8f607d7d1cc502c43a932a275a56fe47db50271904513a379d39df1af277ac48

  - name: python3-css-parser
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app css_parser-1.0.6-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/64/7a/5ea4d019d36e07026ac194817104ef2e82ba1384aab69fb75ebf56de97c2/css_parser-1.0.6-py2.py3-none-any.whl
        sha256: 6fc4f8f0a4b62c77f043765e375cc64971c54ff9a0502fec7e8f1fb28bb96082

  - name: python3-precis_i18n
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app precis_i18n-1.0.3-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c1/28/0df691ebe7e28a68b839887ce81be07d30cf165b6013c10009184284a303/precis_i18n-1.0.3-py3-none-any.whl
        sha256: b9a4ff1f2f8c4a762393cb1b80bf4cadfbe861ec299f752068cc42f281322d45

  # GSound dependency
  - name: libcanberra
    sources:
      - type: archive
        url: http://0pointer.de/lennart/projects/libcanberra/libcanberra-0.30.tar.xz
        sha256: c2b671e67e0c288a69fc33dc1b6f1b534d07882c2aceed37004bf48c601afa72
    config-opts:
      - "--disable-alsa"
      - "--disable-null"
      - "--disable-oss"

  - name: gsound
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gsound/1.0/gsound-1.0.2.tar.xz
        sha256: bba8ff30eea815037e53bee727bbd5f0b6a2e74d452a7711b819a7c444e78e53

  - name: gspell
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gspell/1.8/gspell-1.8.4.tar.xz
        sha256: cf4d16a716e813449bd631405dc1001ea89537b8cdae2b8abfb3999212bd43b4

  - name: farstream
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/farstream/farstream.git
        tag: 0.2.9
        commit: 1e42278d11730f8409878e3b4904fdd47e360e6f
      - type: patch
        path: farstream-make-4.3.patch

  - name: python3-nbxmpp
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app .
    sources:
      - type: git
        url: https://dev.gajim.org/gajim/python-nbxmpp.git

  - name: gajim
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app .
      - touch /app/share/run-as-flatpak
      - echo -e '#!/bin/sh\ngajim --gapplication-app-id=org.gajim.Gajim.Devel "$@"' > /app/bin/gajim-devel
      - chmod 755 /app/bin/gajim-devel
    sources:
      - type: git
        url: https://dev.gajim.org/gajim/gajim.git
      - type: shell
        commands:
          - sed -i "s+<id>org.gajim.Gajim</id>+<id>org.gajim.Gajim.Devel</id>+" data/org.gajim.Gajim.appdata.xml.in
          - sed -i "s+<name>Gajim</name>+<name>Gajim (Nightly)</name>+" data/org.gajim.Gajim.appdata.xml.in
          - sed -i "s+Exec=gajim+Exec=gajim-devel+" data/org.gajim.Gajim.desktop.in
          - mv gajim/data/icons/hicolor/scalable/apps/org.gajim.Gajim{.Devel,}.svg
    post-install:
      - install -d /app/plugins
