app-id: org.gajim.Gajim
runtime: org.gnome.Platform
runtime-version: '41'
sdk: org.gnome.Sdk
command: gajim
finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --system-talk-name=org.freedesktop.GeoClue2
  - --system-talk-name=org.freedesktop.login1
  - --talk-name=org.mpris.MediaPlayer2.*
  - --talk-name=org.freedesktop.portal.Fcitx
  # Automatic status
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.gnome.Mutter.IdleMonitor
  # Keyring
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd5
  # GnuPG
  - --filesystem=~/.gnupg
  # camera access
  - --device=all
  # extensions
  - --env=PYTHONPATH=/app/plugins/site-packages
  - --env=GI_TYPELIB_PATH=/app/lib/girepository-1.0:/app/plugins/lib/girepository-1.0

add-extensions:
  org.gajim.Gajim.Plugin:
    directory: plugins
    merge-dirs: lib;site-packages
    add-ld-path: lib
    subdirectories: true
    no-autodownload: true
    autodelete: true

build-options:
  env:
    PIP_PREFIX: /app

cleanup:
  - /include
  - /lib/debug
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - '*.a'
  - '*.la'

modules:
  - name: python3-pyparsing
    buildsystem: simple
    build-commands:
      - pip3 install pyparsing-2.4.7-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/p/pyparsing/pyparsing-2.4.7-py2.py3-none-any.whl
        sha256: ef9d7589ef3c200abe66653d3f1ab1033c3c419ae9b9bdb1240a85b024efc88b

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - pip3 install packaging-21.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/p/packaging/packaging-21.0-py3-none-any.whl
        sha256: c86254f9220d55e31cc94d69bade760f0847da8000def4dfe1c6b872fd14ff14

  - name: python3-pycparser
    buildsystem: simple
    build-commands:
      - pip3 install pycparser-2.20-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/p/pycparser/pycparser-2.20-py2.py3-none-any.whl
        sha256: 7582ad22678f0fcd81102833f60ef8d0e57288b6b5fb00323d101be910e35705

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/c/cffi/cffi-1.14.6.tar.gz
        sha256: c9a875ce9d7fe32887784274dd533c57909b7b1dcadcc128a2ac21331a9765dd

  - name: python3-asn1crypto
    buildsystem: simple
    build-commands:
      - pip3 install asn1crypto-1.4.0-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/a/asn1crypto/asn1crypto-1.4.0-py2.py3-none-any.whl
        sha256: 4bcdf33c861c7d40bdcd74d8e4dd7661aac320fcdf40b9a3f95b4ee12fde2fa8

  - name: python3-idna
    buildsystem: simple
    build-commands:
      - pip3 install idna-3.2-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/i/idna/idna-3.2-py3-none-any.whl
        sha256: 14475042e284991034cb48e06f6851428fb14c4dc953acd9be9a5e95c7b6dd7a

  - name: python3-cryptography
    buildsystem: simple
    only-arches:
      - aarch64
    build-commands:
      - pip3 install cryptography-3.4.8-cp36-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cp36/c/cryptography/cryptography-3.4.8-cp36-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
        sha256: 34dae04a0dce5730d8eb7894eab617d8a70d0c97da76b905de9efb7128ad7085

  - name: python3-cryptography
    buildsystem: simple
    only-arches:
      - x86_64
    build-commands:
      - pip3 install cryptography-3.4.8-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cp36/c/cryptography/cryptography-3.4.8-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 1eb7bb0df6f6f583dd8e054689def236255161ebbcf62b226454ab9ec663746b

  - name: python3-pyopenssl
    buildsystem: simple
    build-commands:
      - pip3 install pyOpenSSL-20.0.1-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/p/pyOpenSSL/pyOpenSSL-20.0.1-py2.py3-none-any.whl
        sha256: 818ae18e06922c066f777a33f1fca45786d85edfe71cd043de6379337a7f274b

  - name: python3-dbus-python
    build-options:
      env:
        PYTHON_VERSION: '3'
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/d/dbus-python/dbus-python-1.2.16.tar.gz
        sha256: 11238f1d86c995d8aed2e22f04a1e3779f0d70e587caffeab4857f3c662ed5a4

  - name: python3-jeepney
    buildsystem: simple
    build-commands:
      - pip3 install jeepney-0.7.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/j/jeepney/jeepney-0.7.1-py3-none-any.whl
        sha256: 1b5a0ea5c0e7b166b2f5895b91a08c14de8915afda4407fb5022a195224958ac

  - name: python3-secretstorage
    buildsystem: simple
    build-commands:
      - pip3 install SecretStorage-3.3.1-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/S/SecretStorage/SecretStorage-3.3.1-py3-none-any.whl
        sha256: 422d82c36172d88d6a0ed5afdec956514b189ddbfb72fefab0c8a1cee4eaf71f

  - name: python3-zipp
    buildsystem: simple
    build-commands:
      - pip3 install zipp-3.5.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/z/zipp/zipp-3.5.0-py3-none-any.whl
        sha256: 957cfda87797e389580cb8b9e3870841ca991e2125350677b2ca83a0e99390a3

  # keyring dependency
  - name: python3-importlib-metadata
    buildsystem: simple
    build-commands:
      - pip3 install importlib_metadata-4.8.1-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/i/importlib_metadata/importlib_metadata-4.8.1-py3-none-any.whl
        sha256: b618b6d2d5ffa2f16add5697cf57a46c76a56229b0ed1c438322e4e95645bd15

  - name: python3-keyring
    buildsystem: simple
    build-commands:
      - pip3 install keyring-23.2.1-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/k/keyring/keyring-23.2.1-py3-none-any.whl
        sha256: bd2145a237ed70c8ce72978b497619ddfcae640b6dcf494402d5143e37755c6e

  - name: python3-css-parser
    buildsystem: simple
    build-commands:
      - pip3 install css_parser-1.0.6-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py2.py3/c/css_parser/css_parser-1.0.6-py2.py3-none-any.whl
        sha256: 6fc4f8f0a4b62c77f043765e375cc64971c54ff9a0502fec7e8f1fb28bb96082

  - name: python3-precis_i18n
    buildsystem: simple
    build-commands:
      - pip3 install precis_i18n-1.0.3-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/p/precis_i18n/precis_i18n-1.0.3-py3-none-any.whl
        sha256: b9a4ff1f2f8c4a762393cb1b80bf4cadfbe861ec299f752068cc42f281322d45

  # gssapi dependency
  - name: python3-decorator
    buildsystem: simple
    build-commands:
      - pip3 install decorator-5.1.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/d/decorator/decorator-5.1.0-py3-none-any.whl
        sha256: 7b12e7c3c6ab203a29e157335e9122cb03de9ab7264b137594103fd4a683b374

  - name: python3-gssapi
    buildsystem: simple
    build-commands:
      - pip3 install .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/g/gssapi/gssapi-1.7.0.tar.gz
        sha256: e7b8ae92033f9b487762f7dc7dbf55616b27cf767c1fc0126cdc88414df4111c

  # GSound dependency
  - name: libcanberra
    sources:
      - type: archive
        url: http://0pointer.de/lennart/projects/libcanberra/libcanberra-0.30.tar.xz
        sha256: c2b671e67e0c288a69fc33dc1b6f1b534d07882c2aceed37004bf48c601afa72
    config-opts:
      - "--disable-alsa"
      - "--disable-null"
      - "--disable-oss"

  - name: gsound
    buildsystem: meson
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gsound/1.0/gsound-1.0.3.tar.xz
        sha256: ca2d039e1ebd148647017a7f548862350bc9af01986d39f10cfdc8e95f07881a

  - name: gspell
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gspell/1.8/gspell-1.8.4.tar.xz
        sha256: cf4d16a716e813449bd631405dc1001ea89537b8cdae2b8abfb3999212bd43b4

  - name: farstream
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/farstream/farstream.git
        tag: 0.2.9
        commit: 1e42278d11730f8409878e3b4904fdd47e360e6f
      - type: patch
        path: farstream-make-4.3.patch

  - name: python3-nbxmpp
    buildsystem: simple
    build-commands:
      - pip3 install nbxmpp-2.0.4-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/n/nbxmpp/nbxmpp-2.0.4-py3-none-any.whl
        sha256: 38b816e117fb629d682bc62d7e24ff1ac1fd97d12476386fb1d96d158b4d1b48

  - name: gajim
    buildsystem: simple
    build-commands:
      - pip3 install .
      - touch /app/share/run-as-flatpak
    sources:
      - type: git
        url: https://dev.gajim.org/gajim/gajim.git
        branch: gajim_1.3
    post-install:
      - install -d /app/plugins
